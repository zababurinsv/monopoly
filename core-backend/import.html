<!DOCTYPE html>
<html lang="en">
<head>
    <title>Property</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <script src="//cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        eruda.init();
    </script>
</head>
<body>
<section id="property">
    <hr>
        <div class="preview">Property</div>
    <hr>
    <div id="components">

    </div>
    <div id="info">

    </div>
    <div id="tests">
        <ul id="mocha"></ul>
    </div>
</section>
</body>
<script type="module">
    import emoji from '/static/html/components/component_modules/emoji/emoji.mjs'
    import white from '/static/html/components/component_modules/white/white.mjs'
    import events from '/static/html/components/component_modules/CustomEvent/index.mjs'
    import iframe from '/static/html/components/component_modules/iframe/iframe.mjs'
    import isEmpty from '/static/html/components/component_modules/isEmpty/isEmpty.mjs'

    let verifyOpener = false
    try{ isEmpty(window.opener) }catch (e) { verifyOpener = true }
    if(verifyOpener){
        window.opener.postMessage('init','*')
    }
    window.addEventListener ("message", async (event) => {
        if(white.includes(event.origin)){
            if(location.origin !== event.origin){
                iframe.setPort2(event.origin, event.ports[0],async (event)=>{
                    console.log(`<<<<<1 request waves-game ${emoji('fire')}`, event.data.property)
                    let response = await events.customEvent(event.data.view,event.data.property,event.data.color,event.data.substrate,event.data.relation)
                    iframe.getPort2(event.data.property, event.data.window).postMessage({
                        view:true,
                        propery:`${emoji('fire')} waves-game response >>>>>`,
                        color:event.data.color,
                        substrate:{},
                        relation:event.data.relation
                    })
                }, event.data.window)
                if(event.data.window === true){
                    iframe.getPort2(event.origin, event.data.window).postMessage(

                        `${emoji('fire')} init response end >>>>>`
                    );
                }else{
                    console.log(`<<<<< request init ${location.origin} ${emoji('fire')}`,event.data, event.data.relation)

                    events.eventListener.set(event.data.view,event.data.property,event.data.color,event.data.substrate,event.data.relation,async (object)=>{
                        console.log(`${emoji('fire')} ${location.origin} response >>>>>`, object)
                        iframe.getPort2(event.origin).postMessage({
                            view:true,
                            propery:`${emoji('fire')} waves-game response >>>>>`,
                            color:event.data.color,
                            substrate:object,
                            relation:event.data.relation
                        });
                    },event.origin)
                    iframe.getPort2(event.origin, event.data.window).postMessage({
                        view:true,
                        propery:`${emoji('fire')} waves-game response >>>>>`,
                        color:event.data.color,
                        substrate:{},
                        relation:event.data.relation
                    });
                }
            }
        }
    })
</script>
<style>
    body{
        display: flex;
        flex-direction: column;
        margin: 0;
    }
    #backend{
        width: 100%;
    }
    div.preview{
        text-align: center;
        font-size: 3vw;
    }
</style>
</html>
